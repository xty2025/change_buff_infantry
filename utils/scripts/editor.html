<!DOCTYPE html>
<html>
<head>
    <title>HUSTLYRMER CONFIG DEBUG</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/10.1.3/jsoneditor.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/10.1.3/jsoneditor.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        /* JSONé…ç½®ç¼–è¾‘å™¨ */
        #editor {
            width: 75%;
            height: 600px;
            border: 1px solid #ccc;
            resize: both;
            overflow: auto;
        }
        button { padding: 10px 20px; margin: 10px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background: #45a049; }
        
        /* è§†é¢‘çª—å£ - é‡æ–°è®¾è®¡ */
        #video-container {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 320px;
            height: 240px;
            border: 1px solid #ccc;
            background: white;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        /* é¡¶éƒ¨æ‹–åŠ¨è°ƒæ•´æ  */
        #video-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background: #f0f0f0;
            cursor: move;
            user-select: none;
            border-bottom: 1px solid #ddd;
        }
        
        /* è§†é¢‘å†…å®¹åŒºåŸŸ */
        #video-content {
            flex: 1;
            position: relative; /* å­å…ƒç´ ç›¸å¯¹äºæ­¤å®šä½ */
            overflow: hidden;
        }
        
        /* è§†é¢‘æµ */
        #videoStream {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        
        /* è°ƒæ•´å¤§å°çš„æ§åˆ¶ç‚¹ */
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
        }
        .resize-handle.se {
            right: -5px;
            bottom: -5px;
            cursor: nwse-resize;
        }
        .resize-handle.sw {
            left: -5px;
            bottom: -5px;
            cursor: nesw-resize;
        }
        .resize-handle.ne {
            right: -5px;
            top: -5px;
            cursor: nesw-resize;
        }
        .resize-handle.nw {
            left: -5px;
            top: -5px;
            cursor: nwse-resize;
        }
    </style>
</head>
<body>
    <h1>HUSTLYRMER CONFIG DEBUG</h1>
    <button onclick="loadConfig()">åŠ è½½é…ç½®</button>
    <button onclick="saveConfig()">ä¿å­˜é…ç½®</button>
    <div id="editor"></div>

    <div id="video-container">
        <div id="video-header">
            <div id="streamStatus">è§†é¢‘æµæ£€æµ‹ä¸­...</div>
            <div style="font-size: 0.8em; color: #666;">æ‹–åŠ¨æ”¹å˜ä½ç½®</div>
        </div>
        <div id="video-content">
            <img id="videoStream" src="{{ url_for('video_feed') }}">
        </div>
        <!-- è°ƒæ•´å¤§å°çš„æ§åˆ¶ç‚¹ -->
        <div class="resize-handle se"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle nw"></div>
    </div>

    <script>
        const editor = new JSONEditor(document.getElementById('editor'), { mode: 'code' });

        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                if (!res.ok) throw new Error(await res.text());
                editor.set(await res.json());
            } catch (e) {
                alert('åŠ è½½å¤±è´¥: ' + e.message);
            }
        }

        async function saveConfig() {
            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(editor.get())
                });
                const result = await res.json();
                alert(res.ok ? 'ä¿å­˜æˆåŠŸ' : 'ä¿å­˜å¤±è´¥: ' + (result.error || ''));
            } catch (e) {
                alert('è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        // è§†é¢‘æµçŠ¶æ€ç›‘æ§
        const video = document.getElementById('videoStream');
        const status = document.getElementById('streamStatus');
        setInterval(() => {
            status.textContent = video.naturalWidth > 0 ? 'ğŸŸ¢ è¿è¡Œä¸­' : 'ğŸ”´ æœªè¿æ¥';
            status.style.color = video.naturalWidth > 0 ? '#4CAF50' : '#ff4444';
        }, 1000);

        // å®ç°æ‹–åŠ¨å’Œè°ƒæ•´å¤§å°
        const videoContainer = document.getElementById('video-container');
        const videoHeader = document.getElementById('video-header');
        let isDragging = false;
        let isResizing = false;
        let currentResizer = null;
        let offsetX, offsetY, initialX, initialY, initialWidth, initialHeight;

        // æ‹–åŠ¨åŠŸèƒ½
        videoHeader.addEventListener('mousedown', (e) => {
            isDragging = true;
            offsetX = e.clientX - videoContainer.getBoundingClientRect().left;
            offsetY = e.clientY - videoContainer.getBoundingClientRect().top;
        });

        // è°ƒæ•´å¤§å°åŠŸèƒ½
        document.querySelectorAll('.resize-handle').forEach(handle => {
            handle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                isResizing = true;
                currentResizer = e.target;
                initialX = e.clientX;
                initialY = e.clientY;
                initialWidth = videoContainer.offsetWidth;
                initialHeight = videoContainer.offsetHeight;
            });
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                videoContainer.style.left = (e.clientX - offsetX) + 'px';
                videoContainer.style.top = (e.clientY - offsetY) + 'px';
                videoContainer.style.right = 'auto'; // å–æ¶ˆå³ä¾§å›ºå®š
            } else if (isResizing) {
                e.preventDefault();
                
                let newWidth = initialWidth;
                let newHeight = initialHeight;
                
                // è®¡ç®—æ–°å°ºå¯¸
                if (currentResizer.classList.contains('se')) {
                    newWidth = initialWidth + (e.clientX - initialX);
                    newHeight = initialHeight + (e.clientY - initialY);
                } else if (currentResizer.classList.contains('sw')) {
                    newWidth = initialWidth - (e.clientX - initialX);
                    newHeight = initialHeight + (e.clientY - initialY);
                    if (newWidth > 100) videoContainer.style.left = (e.clientX) + 'px';
                } else if (currentResizer.classList.contains('ne')) {
                    newWidth = initialWidth + (e.clientX - initialX);
                    newHeight = initialHeight - (e.clientY - initialY);
                    if (newHeight > 100) videoContainer.style.top = (e.clientY) + 'px';
                } else if (currentResizer.classList.contains('nw')) {
                    newWidth = initialWidth - (e.clientX - initialX);
                    newHeight = initialHeight - (e.clientY - initialY);
                    if (newWidth > 100) videoContainer.style.left = (e.clientX) + 'px';
                    if (newHeight > 100) videoContainer.style.top = (e.clientY) + 'px';
                }
                
                // åº”ç”¨æœ€å°å°ºå¯¸é™åˆ¶
                if (newWidth > 100) videoContainer.style.width = newWidth + 'px';
                if (newHeight > 100) videoContainer.style.height = newHeight + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            isResizing = false;
        });

        loadConfig();
    </script>
</body>
</html>